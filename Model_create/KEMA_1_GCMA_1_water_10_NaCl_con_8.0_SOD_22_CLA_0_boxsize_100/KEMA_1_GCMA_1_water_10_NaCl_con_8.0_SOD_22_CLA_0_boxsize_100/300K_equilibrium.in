# Variable                                                                                                                                              
variable		npt_step	equal	50000000           # 50 ns                                                                                            
variable		npt_thermo	equal	${npt_step}/500                                                                                                       
variable        small_step  equal   10                                                                                                                  
variable        criteria    equal   0.00001                                                                                                                
variable        filename    string  input.data                                                                                                          
units           real                                                                                                                                    
timestep        1                                                                                                                                       
                                                                                                                                                        
# Potential define                                                                                                                                      
newton          off                                                                                                                                     
atom_style      full                                                                                                                                    
bond_style      harmonic                                                                                                                                
angle_style     charmm                                                                                                                                  
dihedral_style  charmmfsw                                                                                                                               
improper_style  harmonic                                                                                                                                
pair_style      lj/charmmfsw/coul/long 10 12                                                                                                            
kspace_style    pppm 1e-6                                                                                                                               
pair_modify     mix arithmetic                                                                                                                          
                                                                                                                                                        
# Modify following line to point to the desired CMAP file                                                                                               
fix             cmap all cmap charmm36.cmap                                                                                                             
fix_modify      cmap energy yes                                                                                                                         
read_data       ${filename} fix cmap crossterm CMAP                                                                                                     
pair_coeff      48 51 0.154919 3.24019863787641 0.154919 3.24019863787641
pair_coeff      21 51 0.07502 2.8776028595933 0.07502 2.8776028595933

special_bonds   charmm                                                                                                                                                
                                                                                                                                                                      
# Minimized                                                                                                                                                           
neigh_modify    every 1 delay 0 check yes                                                                                                                             
min_style       cg                                                                                                                                                    
minimize        0.0 1.0e-9 100000 1000000                                                                                                                             
write_data      minimized.data pair ij                                                                                                                                
velocity        all create 300 23112 dist gaussian                                                                                                                    
                                                                                                                                                                      
# Setup                                                                                                                                                               
fix 			1 all npt temp 300.0 300.0 100.0 iso 1 1 1000.0                                                                                                       
thermo_style    custom step time xlo xhi ylo yhi zlo zhi etotal pe ke ebond temp press eangle edihed eimp evdwl ecoul elong vol density                               
                                                                                                                                                                      
# Prevent PPPM error                                                                                                                                                  
dump            1 all dcd ${small_step} PPPM.dcd 
dump_modify     1 unwrap yes                     

label           loopa                                                                                                                                                 
variable        xlo equal xlo                                                                                                                                         
variable        xhi equal xhi                                                                                                                                         
variable        x_initial equal ${xhi}-${xlo}                                                                                                                         
                                                                                                                                                                      
variable        ylo equal ylo                                                                                                                                         
variable        yhi equal yhi                                                                                                                                         
variable        y_initial equal ${yhi}-${ylo}                                                                                                                         
                                                                                                                                                                      
variable        zlo equal zlo                                                                                                                                         
variable        zhi equal zhi                                                                                                                                         
variable        z_initial equal ${zhi}-${zlo}                                                                                                                         
                                                                                                                                                                      
run             ${small_step}                                                                                                                                         
minimize        0.0 1.0e-9 100000 1000000                                                                                                                                         
variable        x_end equal lx                                                                                                                                        
variable        y_end equal ly                                                                                                                                        
variable        z_end equal lz                                                                                                                                        
                                                                                                                                                                      
variable        xchange equal abs(${x_initial}-${x_end})                                                                                                                   
variable        ychange equal abs(${y_initial}-${y_end})                                                                                                                   
variable        zchange equal abs(${z_initial}-${z_end})                                                                                                                   
                                                                                                                                                                      
print           "Change ${xchange} ${ychange} ${zchange}"                                                                                                             
write_data      PPPM.data pair ij                                    
write_dump      all custom PPPM.dump id type x y z vx vy vz ix iy iz 
if              "${xchange} > ${criteria}" then "jump SELF loopa"                                                                                                     
if              "${ychange} > ${criteria}" then "jump SELF loopa"                                                                                                     
if              "${zchange} > ${criteria}" then "jump SELF loopa"                                                                                                     
jump            SELF break                                                                                                                                            
                                                                                                                                                                      
label           break                                                                                                                                                 
undump          1 
print           "Start Production"                                                                                                                                    
                                                                                                                                                                      
# Setup                                                                                                                                                               
restart 		${npt_thermo} ./restart/300K_equilibrium.restart                                                                                                      
dump            1 all dcd ${npt_thermo} 300K_equilibrium.dcd                                                                                                          
dump_modify     1 unwrap yes                                                                                                                                          
thermo          ${npt_thermo}                                                                                                                                         
                                                                                                                                                                      
# NPT 300K                                                                                                                                                            
fix 			1 all npt temp 300.0 300.0 100.0 iso 1 1 1000.0                                                                                                       
run             ${npt_step}                                                                                                                                           
write_data      300K_equilibrium.data pair ij                                                                                                                         
write_dump      all custom 300K_equilibrium.dump id type x y z vx vy vz ix iy iz                                                                                      
